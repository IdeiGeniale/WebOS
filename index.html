<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Web OS Simulator</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; font-family: sans-serif; background: #1e1e2e; }
    #desktop { position: absolute; top: 0; bottom: 40px; left: 0; right: 0; display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background: url('https://wallpapercave.com/wp/wp4538341.jpg') no-repeat center center/cover; }
    .icon { width: 80px; text-align: center; color: white; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 10px; cursor: pointer; }
    .icon:hover { background: rgba(0,0,0,0.7); }
    #taskbar { position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: rgba(20,20,20,0.8); display: flex; align-items: center; justify-content: space-between; padding: 0 10px; }
    #start-button { background: #0078D7; color: white; padding: 0 10px; height: 100%; display: flex; align-items: center; cursor: pointer; font-weight: bold; }
    #taskbar-apps { display: flex; gap: 10px; overflow-x: auto; }
    #taskbar-apps div { padding: 0 10px; color: white; cursor: pointer; }
    #clock { color: white; font-weight: bold; }
    .window { 
      position: absolute; 
      background: white; 
      border: 2px solid black; 
      width: 300px; 
      height: 300px; 
      display: none; 
      flex-direction: column; 
      z-index: 10; 
      resize: both; 
      overflow: auto;
      min-width: 200px;
      min-height: 200px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    .window.calculator { 
      width: 350px;
      height: 400px;
    }
    .window-header { 
      background: #333; 
      color: white; 
      padding: 5px; 
      display: flex; 
      justify-content: space-between; 
      cursor: move; 
      user-select: none;
    }
    .window-body { 
      flex-grow: 1; 
      background: #f0f0f0; 
      overflow: auto; 
      display: flex; 
      flex-direction: column; 
      padding: 10px; 
    }
    #imagePreview img, #videoPreview video { max-width: 100px; margin: 10px; border: 2px solid #ccc; }
    .window button { cursor: pointer; padding: 2px 8px; margin-left: 5px; }
    #fileList ul { list-style: none; padding: 0; }
    #fileList li { padding: 5px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; }
    
    /* Login screen styles */
    #login-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #login-form {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      text-align: center;
    }
    #login-form input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      box-sizing: border-box;
    }
    #login-form button {
      background: #0078D7;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
      width: 100%;
    }
    #login-form button:hover {
      background: #005fa3;
    }
    #login-error {
      color: red;
      margin-top: 10px;
      display: none;
    }

    /* Calendar styles */
    #calendarGrid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    #calendarGrid div {
      text-align: center;
      padding: 5px;
      border-radius: 3px;
    }
    #calendarEvents {
      margin-top: 10px;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }

    /* To-Do styles */
    #taskList {
      list-style: none;
      padding: 0;
      flex: 1;
      overflow: auto;
    }
    #taskList li {
      padding: 5px;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
    }
    #taskList input[type="checkbox"] {
      margin-right: 10px;
    }

    /* Drawing app styles */
    #drawingCanvas {
      touch-action: none;
      background: white;
    }

    /* Start Menu Styles */
    #start-menu {
      position: absolute;
      bottom: 40px;
      left: 0;
      width: 300px;
      background: rgba(30, 30, 46, 0.95);
      border-radius: 8px 8px 0 0;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      display: none;
      flex-direction: column;
      z-index: 100;
      color: white;
      overflow: hidden;
    }
    #start-menu-header {
      padding: 10px;
      background: rgba(0, 120, 215, 0.8);
      font-weight: bold;
    }
    #start-menu-apps {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      padding: 10px;
      overflow-y: auto;
      max-height: 400px;
    }
    .start-menu-app {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
    }
    .start-menu-app:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    .start-menu-app-icon {
      font-size: 24px;
      margin-bottom: 5px;
    }
    .start-menu-app-name {
      font-size: 12px;
    }
    #start-menu-footer {
      padding: 10px;
      background: rgba(20, 20, 20, 0.8);
      display: flex;
      justify-content: space-between;
    }

    /* Taskbar app indicator */
    .taskbar-app {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      display: flex;
      align-items: center;
      padding: 0 10px;
    }
    .taskbar-app.active {
      background: rgba(0, 120, 215, 0.5);
    }
    .taskbar-app:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Email app styles */
    .email-message {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }
    .email-message:hover {
      background-color: #f0f0f0;
    }
    .email-message.unread {
      font-weight: bold;
      background-color: #e6f7ff;
    }
    .email-message-header {
      display: flex;
      justify-content: space-between;
    }
    .email-message-subject {
      font-weight: bold;
    }
    .email-message-preview {
      color: #666;
      font-size: 0.9em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .email-viewer {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    .email-viewer-header {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .email-viewer-body {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }
    .email-viewer-actions {
      padding: 10px;
      border-top: 1px solid #ddd;
      display: flex;
      gap: 10px;
    }
  </style>
  
  <!-- Firebase and EmailJS SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>

  <!-- Login Screen -->
  <div id="login-screen">
    <div id="login-form">
      <h2>Web OS Login</h2>
      <input type="text" id="username" placeholder="User ID" required>
      <input type="password" id="password" placeholder="Access Token" required>
      <button id="login-button">Login</button>
      <div id="login-error">Invalid User ID or Access Token</div>
    </div>
  </div>

  <!-- Main OS Content (hidden until login) -->
  <div id="os-content" style="display: none;">
    <div id="desktop">
      <div class="icon" onclick="openApp('email')">üìß<br>Email</div>
      <div class="icon" onclick="openApp('browser')">üåê<br>Browser</div>
      <div class="icon" onclick="openApp('notepad')">üìù<br>Notepad</div>
      <div class="icon" onclick="openApp('fileeditor')">‚úèÔ∏è<br>Editor</div>
      <div class="icon" onclick="openApp('calculator')">üßÆ<br>Calculator</div>
      <div class="icon" onclick="openApp('terminal')">>_<br>Terminal</div>
      <div class="icon" onclick="openApp('filemanager')">üóÇÔ∏è<br>Files</div>
      <div class="icon" onclick="openApp('settings')">‚öôÔ∏è<br>Settings</div>
      <div class="icon" onclick="openApp('music')">üéµ<br>Music</div>
      <div class="icon" onclick="openApp('mediaviewer')">üñºÔ∏è<br>Media</div>
      <div class="icon" onclick="openApp('games')">üéÆ<br>Games</div>
      <div class="icon" onclick="openApp('todo')">‚úÖ<br>To-Do</div>
      <div class="icon" onclick="openApp('calendar')">üìÖ<br>Calendar</div>
      <div class="icon" onclick="openApp('drawing')">üé®<br>Drawing</div>
    </div>
    <div id="taskbar">
      <div id="start-button" onclick="toggleStartMenu()">Start</div>
      <div id="taskbar-apps"></div>
      <div id="clock"></div>
    </div>

    <!-- Start Menu -->
    <div id="start-menu">
      <div id="start-menu-header">Applications</div>
      <div id="start-menu-apps">
        <div class="start-menu-app" onclick="openAppFromStartMenu('email')">
          <div class="start-menu-app-icon">üìß</div>
          <div class="start-menu-app-name">Email</div>
        </div>

        <div class="start-menu-app" onclick="openAppFromStartMenu('browser')">
          <div class="start-menu-app-icon">üåê</div>
          <div class="start-menu-app-name">Browser</div>
        </div>
        <div class="start-menu-app" onclick="openAppFromStartMenu('notepad')">
          <div class="start-menu-app-icon">üìù</div>
          <div class="start-menu-app-name">Notepad</div>
        </div>
        <div class="start-menu-app" onclick="openAppFromStartMenu('fileeditor')">
          <div class="start-menu-app-icon">‚úèÔ∏è</div>
          <div class="start-menu-app-name">Editor</div>
        </div>
        <div class="start-menu-app" onclick="openAppFromStartMenu('calculator')">
          <div class="start-menu-app-icon">üßÆ</div>
          <div class="start-menu-app-name">Calculator</div>
        </div>
        <div class="start-menu-app" onclick="openAppFromStartMenu('terminal')">
          <div class="start-menu-app-icon">>_</div>
          <div class="start-menu-app-name">Terminal</div>
        </div>
        <div class="start-menu-app" onclick="openAppFromStartMenu('filemanager')">
          <div class="start-menu-app-icon">üóÇÔ∏è</div>
          <div class="start-menu-app-name">Files</div>
        </div>
        <div class="start-menu-app" onclick="openAppFromStartMenu('settings')">
          <div class="start-menu-app-icon">‚öôÔ∏è</div>
          <div class="start-menu-app-name">Settings</div>
        </div>
        <div class="start-menu-app" onclick="openAppFromStartMenu('music')">
          <div class="start-menu-app-icon">üéµ</div>
          <div class="start-menu-app-name">Music</div>
        </div>
        <div class="start-menu-app" onclick="openAppFromStartMenu('mediaviewer')">
          <div class="start-menu-app-icon">üñºÔ∏è</div>
          <div class="start-menu-app-name">Media</div>
        </div>
        <div class="start-menu-app" onclick="openAppFromStartMenu('games')">
          <div class="start-menu-app-icon">üéÆ</div>
          <div class="start-menu-app-name">Games</div>
        </div>
        <div class="start-menu-app" onclick="openAppFromStartMenu('todo')">
          <div class="start-menu-app-icon">‚úÖ</div>
          <div class="start-menu-app-name">To-Do</div>
        </div>
        <div class="start-menu-app" onclick="openAppFromStartMenu('calendar')">
          <div class="start-menu-app-icon">üìÖ</div>
          <div class="start-menu-app-name">Calendar</div>
        </div>
        <div class="start-menu-app" onclick="openAppFromStartMenu('drawing')">
          <div class="start-menu-app-icon">üé®</div>
          <div class="start-menu-app-name">Drawing</div>
        </div>
      </div>
      <div id="start-menu-footer">
        <div id="current-user"></div>
        <button onclick="logout()" style="background: none; border: none; color: white; cursor: pointer;">Logout</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAm8IYAIAV-KntMRHc8cWOztLZnc3H5ptE",
      authDomain: "sysmailx-b8d2f.firebase.app",
      databaseURL: "https://sysmailx-b8d2f-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sysmailx-b8d2f",
      storageBucket: "sysmailx-b8d2f.appspot.com",
      messagingSenderId: "44651159935",
      appId: "1:44651159935:web:e6a6878bb98c0215e03a4a"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ---------- NEW FEATURE ADDED START ----------
    // 6-digit email ID generator + helpers (persisted in localStorage)
    function getUserEmailID(username) {
      if (!username) return null;
      let ids = JSON.parse(localStorage.getItem('userIDs') || '{}');
      if (!ids[username]) {
        // create a stable 6-digit id
        ids[username] = Math.floor(100000 + Math.random() * 900000);
        localStorage.setItem('userIDs', JSON.stringify(ids));
      }
      return ids[username];
    }

    function getFullEmail(username) {
      if (!username) return `000000-guest@webos.com`;
      const id = getUserEmailID(username);
      return `${id}-${username}@webos.com`;
    }

    // Helper to extract base username from an address that may be id-username
    function extractUsernameFromAddress(address) {
      if (!address) return '';
      // address like "179283-idei@webos.com" -> take part before @, then part after first hyphen
      const localPart = address.split('@')[0];
      // If it contains '-', assume format id-username (first '-' separates id and username)
      if (localPart.includes('-')) {
        // remove the first segment (the id)
        const parts = localPart.split('-');
        // username may itself contain hyphens; join the remainder
        return parts.slice(1).join('-');
      }
      return localPart;
    }
    // ---------- NEW FEATURE ADDED END ----------

    // EmailJS Configuration
    emailjs.init("VqHGYEFgo8X-lon9u");

    // User accounts with secure password storage
    const users = {
      "user2": { password: "user2pass", bgColor: "#339af0" },
      "user": { password: "letmein", bgColor: "#51cf66" },
      "guest": { password: "guest", bgColor: "#868e96" }
    };

    // Background color options
    const backgroundColors = {
      "red": "#ff6b6b",
      "green": "#51cf66",
      "blue": "#339af0",
      "white": "#ffffff",
      "yellow": "#ffd43b",
      "gray": "#868e96",
      "purple": "#9c36b5"
    };

    // DOM elements
    const loginScreen = document.getElementById('login-screen');
    const loginForm = document.getElementById('login-form');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('login-button');
    const loginError = document.getElementById('login-error');
    const osContent = document.getElementById('os-content');
    const startMenu = document.getElementById('start-menu');
    const currentUserElement = document.getElementById('current-user');
    const taskbarApps = document.getElementById('taskbar-apps');

    // Track open apps
    const openApps = new Set();

    // Check if user is already logged in
    if (localStorage.getItem('loggedIn')) {
      const savedUsername = localStorage.getItem('username');
      if (users[savedUsername]) {
        loginScreen.style.display = 'none';
        osContent.style.display = 'block';
        applySavedBackground();
        currentUserElement.textContent = savedUsername;
        // initializeFirebaseListeners only when email app opens
      }
    }

    // Login function with enhanced validation
    function handleLogin() {
      const username = usernameInput.value.trim();
      const password = passwordInput.value;
      
      // Reset error state
      loginError.style.display = 'none';
      
      // Validate credentials
      if (users[username] && users[username].password === password) {
        // Successful login
        localStorage.setItem('loggedIn', 'true');
        localStorage.setItem('username', username);
        
        // Set default background if none exists
        if (!localStorage.getItem('background-color')) {
          localStorage.setItem('background-color', users[username].bgColor);
        }
        
        // ensure the user has an email id created now
        getUserEmailID(username);
        
        loginScreen.style.display = 'none';
        osContent.style.display = 'block';
        applySavedBackground();
        currentUserElement.textContent = username;
        
        // Do not initialize file manager/email listeners here ‚Äî wait until app opens.
      } else {
        // Failed login
        loginError.style.display = 'block';
        passwordInput.value = ''; // Clear password field
        passwordInput.focus(); // Refocus on password field
      }
    }

    // Logout function
    function logout() {
      localStorage.removeItem('loggedIn');
      localStorage.removeItem('username');
      location.reload();
    }

    // Event listeners for login
    loginButton.addEventListener('click', handleLogin);
    
    // Allow login on Enter key
    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleLogin();
      }
    });

    function applySavedBackground() {
      const bgColor = localStorage.getItem('background-color');
      if (bgColor) {
        document.getElementById('desktop').style.background = bgColor;
      }
    }

    function updateClock() {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      document.getElementById('clock').textContent = `${h}:${m}:${s}`;
    }
    setInterval(updateClock, 1000);
    updateClock();
    
    // Toggle start menu visibility
    function toggleStartMenu() {
      if (startMenu.style.display === 'flex') {
        startMenu.style.display = 'none';
      } else {
        startMenu.style.display = 'flex';
      }
    }

    // Close start menu when clicking outside
    document.addEventListener('click', (e) => {
      const isStartButton = e.target && (e.target.id === 'start-button' || e.target.closest && e.target.closest('#start-button'));
      if (!startMenu.contains(e.target) && !isStartButton) {
        startMenu.style.display = 'none';
      }
    });

    // Open app from start menu
    function openAppFromStartMenu(id) {
      openApp(id);
      startMenu.style.display = 'none';
    }

    // Function to update email address display
    function updateEmailAddressDisplay() {
      const currentUser = localStorage.getItem('username') || 'guest';
      const emailAddress = getFullEmail(currentUser);
      const emailDisplayElement = document.getElementById('user-email-address');
      if (emailDisplayElement) {
        emailDisplayElement.textContent = emailAddress;
      }
    }
    
    const apps = {
      email: `<div class='window' id='email'>
                <div class='window-header' onmousedown='dragWindow(event, this.parentElement)'>
                  Email <button onclick='closeApp("email")'>X</button>
                </div>
                <div class='window-body' style="display:flex;flex-direction:column;gap:8px;">
                  <!-- ADDED: Email address display -->
                  <div id="email-address-display" style="padding: 5px; background: #e6f7ff; border-radius: 4px; font-size: 12px; margin-bottom: 5px; text-align: center;">
                    Your email address: <span id="user-email-address">Loading...</span>
                  </div>
                  
                  <div style="display:flex;gap:5px;margin-bottom:5px;">
                    <button onclick="showCompose()">‚úâÔ∏è Compose</button>
                    <button onclick="showInbox()">üì• Inbox</button>
                    <button onclick="showSent()">üì§ Sent</button>
                  </div>

                  <div id="email-compose" style="display:none;flex-direction:column;gap:6px;">
                    <input id="emailTo" type="email" placeholder="To: user@webos.com" style="width:100%;padding:6px;" />
                    <input id="emailSubject" type="text" placeholder="Subject" style="width:100%;padding:6px;" />
                    <textarea id="emailMessage" placeholder="Write your message..." style="flex:1;resize:none;width:100%;height:140px;padding:6px;"></textarea>
                    <div style="display:flex;gap:8px;">
                      <button onclick="sendEmail()">Send</button>
                      <button onclick="saveDraft()">Save Draft</button>
                    </div>
                    <div id="emailStatus" style="margin-top:6px;font-size:12px;color:#555;"></div>
                  </div>

                  <div id="email-inbox" style="display:none;">
                    <h3>Inbox</h3>
                    <div id="inboxList" style="flex:1;overflow:auto;"></div>
                  </div>

                  <div id="email-sent" style="display:none;">
                    <h3>Sent</h3>
                    <div id="sentList" style="flex:1;overflow:auto;"></div>
                  </div>

                  <div id="email-viewer" class="email-viewer">
                    <div class="email-viewer-header">
                      <div><strong id="viewer-subject"></strong></div>
                      <div>From: <span id="viewer-from"></span></div>
                      <div>Date: <span id="viewer-date"></span></div>
                    </div>
                    <div class="email-viewer-body" id="viewer-body"></div>
                    <div class="email-viewer-actions">
                      <button onclick="closeEmailViewer()">Back</button>
                      <button onclick="replyToEmail()">Reply</button>
                      <button onclick="deleteEmail()">Delete</button>
                    </div>
                  </div>

                </div>
              </div>`,
      browser: `<div class='window' id='browser'>
                <div class='window-header' onmousedown='dragWindow(event, this.parentElement)'>
                  Browser <button onclick='closeApp("browser")'>X</button>
                </div>
                <div class='window-body'>
                  <div style="display:flex;gap:5px;margin-bottom:5px;">
                    <button onclick='goBack()' title="Back">‚Üê</button>
                    <button onclick='goForward()' title="Forward">‚Üí</button>
                    <button onclick='refreshPage()' title="Refresh">‚Üª</button>
                    <input id='urlInput' placeholder='Enter URL' style="flex:1;" 
                           onkeydown='if(event.key==="Enter") loadBrowserPage()'>
                    <button onclick='loadBrowserPage()'>Go</button>
                    <button onclick='openInNewTab()' title="Open in new tab">‚Üó</button>
                  </div>
                  <iframe id='browserFrame' sandbox="allow-scripts allow-same-origin allow-forms" 
                          style='flex:1; border:none; background:white;'></iframe>
                  <div id='browserStatus' style="font-size:12px;color:#666;"></div>
                </div>
              </div>`,
      notepad: `<div class='window' id='notepad'><div class='window-header' onmousedown='dragWindow(event, this.parentElement)'>Notepad <button onclick='closeApp("notepad")'>X</button></div><div class='window-body'><textarea id='noteArea' style='flex:1; resize:none;'></textarea><button onclick='saveNote()'>Save Note</button></div></div>`,
      fileeditor: `<div class='window' id='fileeditor'><div class='window-header' onmousedown='dragWindow(event, this.parentElement)'>File Editor <button onclick='closeApp("fileeditor")'>X</button></div><div class='window-body'><textarea id='fileEditArea' placeholder='Edit text here...' style='flex:1; resize:none;'></textarea><input type='text' id='fileEditName' placeholder='Filename' /><button onclick='saveFile()'>Save File</button></div></div>`,
      filemanager: `<div class='window' id='filemanager'><div class='window-header' onmousedown='dragWindow(event, this.parentElement)'>File Manager <button onclick='closeApp("filemanager")'>X</button></div><div class='window-body' id='fileList'></div></div>`,
      calculator: `<div class='window calculator' id='calculator'><div class='window-header' onmousedown='dragWindow(event, this.parentElement)'>Calculator <button onclick='closeApp("calculator")'>X</button></div><div class='window-body'><iframe src='https://www.desmos.com/scientific' style='flex:1; border:none;'></iframe></div></div>`,
      terminal: `<div class='window' id='terminal'>
  <div class='window-header' onmousedown='dragWindow(event, this.parentElement)'>
    Terminal <button onclick='closeApp("terminal")'>X</button>
  </div>
  <div class='window-body' id='terminal-body' style='flex-direction: column;'>
    <div id='terminal-output' style='flex:1; overflow-y:auto; white-space:pre-wrap; font-family: monospace; background:#000; color:#0f0; padding:5px;'>Web OS Terminal</div>
    <input id='terminal-input' type='text' placeholder='Type a command...' 
           style='width:100%;padding:5px;box-sizing:border-box;font-family:monospace; background:#111; color:#0f0; border:none; outline:none;'
           onkeydown='handleTerminalCommand(event)'>
  </div>
</div>`,
      settings: `<div class='window' id='settings'><div class='window-header' onmousedown='dragWindow(event, this.parentElement)'>Settings <button onclick='closeApp("settings")'>X</button></div><div class='window-body'><label>Volume:<input type='range' id='volumeRange' min='0' max='1' step='0.01' onchange='setVolume(this.value)'></label><button onclick='playTestSound()'>Test Sound</button><hr><h3>Background Color</h3><div style='display: flex; gap: 10px; flex-wrap: wrap;'>${Object.entries(backgroundColors).map(([name, color]) => `<div style='background: ${color}; width: 50px; height: 50px; cursor: pointer; border: 2px solid #333;' onclick='changeBackground("${name}")' title='${name}'></div>`).join('')}</div></div></div>`,
      music: `<div class='window' id='music'><div class='window-header' onmousedown='dragWindow(event, this.parentElement)'>Music Player <button onclick='closeApp("music")'>X</button></div><div class='window-body'><input type='file' accept='audio/mpeg,audio/mp4,audio/opus' onchange='playSelectedMusic(event)' /><audio id='musicPlayer' controls style='margin-top:10px;'></audio></div></div>`,
      mediaviewer: `<div class='window' id='mediaviewer'><div class='window-header' onmousedown='dragWindow(event, this.parentElement)'>Media Viewer <button onclick='closeApp("mediaviewer")'>X</button></div><div class='window-body'><input type='file' multiple accept='image/jpeg,image/png,video/mp4,video/avi,video/x-msvideo' onchange='previewMedia(event)'><h3>Images</h3><div id='imagePreview'></div><hr><h3>Videos</h3><div id='videoPreview'></div></div></div>`,
      games: `<div class='window' id='games'><div class='window-header' onmousedown='dragWindow(event, this.parentElement)'>Games <button onclick='closeApp("games")'>X</button></div><div class='window-body'><ul><li><a href='https://flappybird.io' target='_blank'>Flappy Bird</a></li><li><a href='https://www.solitr.com' target='_blank'>Solitaire</a></li><li><a href='https://tetris.com/play-tetris' target='_blank'>Tetris</a></li><li><a href='https://elgoog.im/breakout/' target='_blank'>Breakout</a></li></ul><p><em>More coming soon...</em></p></div></div>`,
      todo: `<div class='window' id='todo'>
              <div class='window-header' onmousedown='dragWindow(event, this.parentElement)'>
                To-Do List <button onclick='closeApp("todo")'>X</button>
              </div>
              <div class='window-body'>
                <div style="display:flex;gap:5px;margin-bottom:10px;">
                  <input type="text" id="newTask" placeholder="New task..." style="flex:1;">
                  <button onclick="addTask()">Add</button>
                </div>
                <ul id="taskList" style="list-style:none;padding:0;flex:1;overflow:auto;"></ul>
              </div>
            </div>`,
      calendar: `<div class='window' id='calendar'>
                  <div class='window-header' onmousedown='dragWindow(event, this.parentElement)'>
                    Calendar <button onclick='closeApp("calendar")'>X</button>
                  </div>
                  <div class='window-body'>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                      <button onclick="changeMonth(-1)">‚óÄ</button>
                      <h3 id="currentMonth" style="margin:0;text-align:center;"></h3>
                      <button onclick="changeMonth(1)">‚ñ∂</button>
                    </div>
                    <div id="calendarGrid" style="display:grid;grid-template-columns:repeat(7, 1fr);gap:5px"></div>
                    <div id="calendarEvents" style="margin-top:10px;border-top:1px solid #ccc;padding-top:10px;"></div>
                  </div>
                </div>`,
      drawing: `<div class='window' id='drawing'>
                  <div class='window-header' onmousedown='dragWindow(event, this.parentElement)'>
                    Drawing App <button onclick='closeApp("drawing")'>X</button>
                  </div>
                  <div class='window-body'>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">
                      <button onclick="setDrawingColor('black')" style="background: black; color: white;">Black</button>
                      <button onclick="setDrawingColor('red')" style="background: red; color: white;">Red</button>
                      <button onclick="setDrawingColor('blue')" style="background: blue; color: white;">Blue</button>
                      <button onclick="setDrawingColor('green')" style="background: green; color: white;">Green</button>
                      <button onclick="setDrawingColor('yellow')" style="background: yellow;">Yellow</button>
                      <button onclick="setDrawingColor('purple')" style="background: purple; color: white;">Purple</button>
                      <input type="color" id="customColor" onchange="setCustomColor(this.value)" title="Custom color">
                      <button onclick="clearDrawing()" style="margin-left: auto;">Clear</button>
                      <button onclick="saveDrawing()">Save Drawing</button>
                    </div>
                    <canvas id="drawingCanvas" style="border: 1px solid #ccc; touch-action: none; width: 100%; height: calc(100% - 40px);"></canvas>
                  </div>
                </div>`
    };

    // App names for taskbar
    const appNames = {
      email: "Email",
      browser: "Browser",
      notepad: "Notepad",
      fileeditor: "File Editor",
      calculator: "Calculator",
      terminal: "Terminal",
      filemanager: "File Manager",
      settings: "Settings",
      music: "Music Player",
      mediaviewer: "Media Viewer",
      games: "Games",
      todo: "To-Do List",
      calendar: "Calendar",
      drawing: "Drawing App"
    };

    // Drawing App Variables
    let currentColor = 'black';
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    // Drawing App Functions
    function initializeDrawingApp() {
      const canvas = document.getElementById('drawingCanvas');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      
      // Set canvas size to match display size
      function resizeCanvas() {
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = Math.max(100, Math.floor(rect.width - 2)); // Account for border
        canvas.height = Math.max(100, Math.floor(rect.height - 42)); // Account for header and buttons
        redrawSavedDrawing();
      }
      
      // Mouse/touch events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      // Touch support
      canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
      canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
      canvas.addEventListener('touchend', stopDrawing);
      
      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();
      
      function startDrawing(e) {
        isDrawing = true;
        const pos = getPosition(e);
        [lastX, lastY] = [pos.x, pos.y];
      }
      
      function draw(e) {
        if (!isDrawing) return;
        const pos = getPosition(e);
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.stroke();
        
        [lastX, lastY] = [pos.x, pos.y];
      }
      
      function stopDrawing() {
        isDrawing = false;
        saveCurrentDrawing();
      }
      
      function handleTouchStart(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
      }
      
      function handleTouchMove(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
      }
      
      function getPosition(e) {
        const rect = canvas.getBoundingClientRect();
        if (e.touches && e.touches[0]) {
          return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top
          };
        } else {
          return {
            x: (e.clientX || 0) - rect.left,
            y: (e.clientY || 0) - rect.top
          };
        }
      }
    }

    function setDrawingColor(color) {
      currentColor = color;
    }

    function setCustomColor(color) {
      currentColor = color;
    }

    function clearDrawing() {
      const canvas = document.getElementById('drawingCanvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      localStorage.removeItem('savedDrawing');
    }

    function saveDrawing() {
      const canvas = document.getElementById('drawingCanvas');
      if (!canvas) return;
      const dataURL = canvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.download = 'webos-drawing.png';
      link.href = dataURL;
      link.click();
    }

    function saveCurrentDrawing() {
      const canvas = document.getElementById('drawingCanvas');
      if (!canvas) return;
      const dataURL = canvas.toDataURL('image/png');
      localStorage.setItem('savedDrawing', dataURL);
    }

    function redrawSavedDrawing() {
      const savedDrawing = localStorage.getItem('savedDrawing');
      if (savedDrawing) {
        const canvas = document.getElementById('drawingCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.onload = function() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        };
        img.src = savedDrawing;
      }
    }

    // Calendar App Variables
    let currentDate = new Date();

    // Calendar App Functions
    function initializeCalendar() {
      updateCalendar();
    }

    function updateCalendar() {
      const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];
      
      const currentMonthElement = document.getElementById('currentMonth');
      if (currentMonthElement) currentMonthElement.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
      
      const calendarGrid = document.getElementById('calendarGrid');
      if (!calendarGrid) return;
      calendarGrid.innerHTML = '';
      
      // Add day headers
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      days.forEach(day => {
        const dayElement = document.createElement('div');
        dayElement.textContent = day;
        dayElement.style.fontWeight = 'bold';
        calendarGrid.appendChild(dayElement);
      });
      
      // Get first day of month
      const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
      
      // Get days in month
      const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
      
      // Add empty cells for days before first day of month
      for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement('div');
        calendarGrid.appendChild(emptyCell);
      }
      
      // Add days of month
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.textContent = day;
        
        // Highlight current day
        const today = new Date();
        if (day === today.getDate() && currentDate.getMonth() === today.getMonth() && currentDate.getFullYear() === today.getFullYear()) {
          dayElement.style.backgroundColor = '#0078D7';
          dayElement.style.color = 'white';
          dayElement.style.borderRadius = '50%';
        }
        
        dayElement.style.cursor = 'pointer';
        dayElement.addEventListener('click', () => showDayEvents(day));
        calendarGrid.appendChild(dayElement);
      }
    }

    function changeMonth(direction) {
      currentDate.setMonth(currentDate.getMonth() + direction);
      updateCalendar();
    }

    function showDayEvents(day) {
      const eventsElement = document.getElementById('calendarEvents');
      if (!eventsElement) return;
      eventsElement.innerHTML = `<h4>Events for ${day}/${currentDate.getMonth() + 1}/${currentDate.getFullYear()}</h4>`;
      
      // In a real app, you would load events from storage
      const events = JSON.parse(localStorage.getItem('calendarEvents') || '{}');
      const dateKey = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}-${day}`;
      
      if (events[dateKey]) {
        events[dateKey].forEach(event => {
          const eventElement = document.createElement('div');
          eventElement.textContent = event;
          eventElement.style.padding = '5px';
          eventElement.style.backgroundColor = '#f0f0f0';
          eventElement.style.marginBottom = '5px';
          eventsElement.appendChild(eventElement);
        });
      } else {
        eventsElement.innerHTML += '<p>No events scheduled.</p>';
      }
      
      // Add event form
      const addEventForm = document.createElement('div');
      addEventForm.innerHTML = `
        <div style="display:flex;gap:5px;margin-top:10px;">
          <input type="text" id="newEvent" placeholder="New event..." style="flex:1;">
          <button onclick="addCalendarEvent(${day})">Add Event</button>
        </div>
      `;
      eventsElement.appendChild(addEventForm);
    }

    function addCalendarEvent(day) {
      const newEventInput = document.getElementById('newEvent');
      if (!newEventInput) return;
      const eventText = newEventInput.value.trim();
      
      if (!eventText) return;
      
      const dateKey = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}-${day}`;
      const events = JSON.parse(localStorage.getItem('calendarEvents') || '{}');
      
      if (!events[dateKey]) {
        events[dateKey] = [];
      }
      
      events[dateKey].push(eventText);
      localStorage.setItem('calendarEvents', JSON.stringify(events));
      
      newEventInput.value = '';
      showDayEvents(day);
    }

    // To-Do App Functions
    function initializeTodo() {
      loadTasks();
    }

    function addTask() {
      const newTaskInput = document.getElementById('newTask');
      if (!newTaskInput) return;
      const taskText = newTaskInput.value.trim();
      
      if (!taskText) return;
      
      const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
      tasks.push({ text: taskText, completed: false });
      localStorage.setItem('tasks', JSON.stringify(tasks));
      
      newTaskInput.value = '';
      loadTasks();
    }

    function loadTasks() {
      const taskList = document.getElementById('taskList');
      if (!taskList) return;
      const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
      
      taskList.innerHTML = '';
      
      tasks.forEach((task, index) => {
        const taskItem = document.createElement('li');
        taskItem.innerHTML = `
          <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${index})">
          <span style="${task.completed ? 'text-decoration: line-through; color: #888;' : ''}">${task.text}</span>
          <button onclick="deleteTask(${index})" style="margin-left: auto;">Delete</button>
        `;
        taskList.appendChild(taskItem);
      });
    }

    function toggleTask(index) {
      const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
      if (!tasks[index]) return;
      tasks[index].completed = !tasks[index].completed;
      localStorage.setItem('tasks', JSON.stringify(tasks));
      loadTasks();
    }

    function deleteTask(index) {
      const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
      tasks.splice(index, 1);
      localStorage.setItem('tasks', JSON.stringify(tasks));
      loadTasks();
    }

    // Email System with EmailJS and Firebase
    let currentEmailView = 'inbox';
    let currentEmail = null;
    
    // Initialize Firebase listeners for real-time email updates
    function initializeFirebaseListeners(username) {
      if (!username) return;
      // Listen for new emails
      database.ref('emails/' + username).on('child_added', (snapshot) => {
        const email = snapshot.val();
        if (email && email.id) {
          // Add email to local storage
          const emails = getEmails();
          if (!emails.find(e => e.id === email.id)) {
            emails.push(email);
            saveEmails(emails);
            
            // Update UI if email app is open
            if (openApps.has('email') && currentEmailView === 'inbox') {
              showInbox();
            }
            
            // Show notification
            showEmailNotification(email);
          }
        }
      });
    }
    
    // Email storage
    function getEmails() {
      return JSON.parse(localStorage.getItem('emails') || '[]');
    }
    
    function saveEmails(emails) {
      localStorage.setItem('emails', JSON.stringify(emails));
    }
    
    // Initialize with sample emails if none exist
    function initializeEmail() {
      const emails = getEmails();
      if (emails.length === 0) {
        const sampleEmails = [
          {
            id: 1,
            from: 'system@webos.com',
            to: getFullEmail(localStorage.getItem('username') || 'guest'),
            subject: 'Welcome to Web OS Email',
            message: 'This is your new email system. You can send and receive emails between different instances of Web OS.',
            date: new Date().toISOString(),
            read: false,
            folder: 'inbox'
          },
          {
            id: 2,
            from: 'support@webos.com',
            to: getFullEmail(localStorage.getItem('username') || 'guest'),
            subject: 'Getting Started Guide',
            message: 'Check out the documentation to learn how to use all the features of Web OS.',
            date: new Date(Date.now() - 3600000).toISOString(),
            read: false,
            folder: 'inbox'
          }
        ];
        saveEmails(sampleEmails);
      }
      // Ensure email address is displayed
      updateEmailAddressDisplay();
      showInbox();
    }
    
    function showCompose() {
      const ec = document.getElementById('email-compose');
      const ei = document.getElementById('email-inbox');
      const es = document.getElementById('email-sent');
      const ev = document.getElementById('email-viewer');
      if (ec) ec.style.display = 'flex';
      if (ei) ei.style.display = 'none';
      if (es) es.style.display = 'none';
      if (ev) ev.style.display = 'none';
      currentEmailView = 'compose';
    }
    
    function showInbox() {
      const ec = document.getElementById('email-compose');
      const ei = document.getElementById('email-inbox');
      const es = document.getElementById('email-sent');
      const ev = document.getElementById('email-viewer');
      if (ec) ec.style.display = 'none';
      if (ei) ei.style.display = 'block';
      if (es) es.style.display = 'none';
      if (ev) ev.style.display = 'none';
      currentEmailView = 'inbox';
      
      const emails = getEmails();
      const inboxList = document.getElementById('inboxList');
      if (!inboxList) return;
      inboxList.innerHTML = '';
      
      const inboxEmails = emails.filter(email => email.folder === 'inbox');
      
      if (inboxEmails.length === 0) {
        inboxList.innerHTML = '<p>No emails in inbox</p>';
        return;
      }
      
      inboxEmails.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      inboxEmails.forEach(email => {
        const emailElement = document.createElement('div');
        emailElement.className = `email-message ${email.read ? '' : 'unread'}`;
        emailElement.innerHTML = `
          <div class="email-message-header">
            <div class="email-message-subject">${email.subject}</div>
            <div>${new Date(email.date).toLocaleDateString()}</div>
          </div>
          <div>From: ${email.from}</div>
          <div class="email-message-preview">${email.message.substring(0, 50)}...</div>
        `;
        emailElement.addEventListener('click', () => viewEmail(email.id));
        inboxList.appendChild(emailElement);
      });
    }
    
    function showSent() {
      const ec = document.getElementById('email-compose');
      const ei = document.getElementById('email-inbox');
      const es = document.getElementById('email-sent');
      const ev = document.getElementById('email-viewer');
      if (ec) ec.style.display = 'none';
      if (ei) ei.style.display = 'none';
      if (es) es.style.display = 'block';
      if (ev) ev.style.display = 'none';
      currentEmailView = 'sent';
      
      const emails = getEmails();
      const sentList = document.getElementById('sentList');
      if (!sentList) return;
      sentList.innerHTML = '';
      
      const sentEmails = emails.filter(email => email.folder === 'sent');
      
      if (sentEmails.length === 0) {
        sentList.innerHTML = '<p>No sent emails</p>';
        return;
      }
      
      sentEmails.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      sentEmails.forEach(email => {
        const emailElement = document.createElement('div');
        emailElement.className = 'email-message';
        emailElement.innerHTML = `
          <div class="email-message-header">
            <div class="email-message-subject">${email.subject}</div>
            <div>${new Date(email.date).toLocaleDateString()}</div>
          </div>
          <div>To: ${email.to}</div>
          <div class="email-message-preview">${email.message.substring(0, 50)}...</div>
        `;
        emailElement.addEventListener('click', () => viewEmail(email.id));
        sentList.appendChild(emailElement);
      });
    }
    
    function viewEmail(id) {
      const emails = getEmails();
      const email = emails.find(e => e.id === id);
      
      if (!email) return;
      
      // Mark as read
      if (!email.read && email.folder === 'inbox') {
        email.read = true;
        saveEmails(emails);
      }
      
      currentEmail = email;
      
      const ec = document.getElementById('email-compose');
      const ei = document.getElementById('email-inbox');
      const es = document.getElementById('email-sent');
      const ev = document.getElementById('email-viewer');
      if (ec) ec.style.display = 'none';
      if (ei) ei.style.display = 'none';
      if (es) es.style.display = 'none';
      if (ev) ev.style.display = 'flex';
      
      const vs = document.getElementById('viewer-subject');
      const vf = document.getElementById('viewer-from');
      const vd = document.getElementById('viewer-date');
      const vb = document.getElementById('viewer-body');
      if (vs) vs.textContent = email.subject;
      if (vf) vf.textContent = email.from;
      if (vd) vd.textContent = new Date(email.date).toLocaleString();
      if (vb) vb.textContent = email.message;
    }
    
    function closeEmailViewer() {
      if (currentEmailView === 'inbox') showInbox();
      else if (currentEmailView === 'sent') showSent();
      else showCompose();
    }
    
    function replyToEmail() {
      if (!currentEmail) return;
      
      const toEl = document.getElementById('emailTo');
      const subEl = document.getElementById('emailSubject');
      const msgEl = document.getElementById('emailMessage');
      if (!toEl || !subEl || !msgEl) return;
      
      toEl.value = currentEmail.from;
      subEl.value = `Re: ${currentEmail.subject}`;
      msgEl.value = `\n\n--- Original Message ---\nFrom: ${currentEmail.from}\nDate: ${new Date(currentEmail.date).toLocaleString()}\n\n${currentEmail.message}`;
      
      showCompose();
    }
    
    function deleteEmail() {
      if (!currentEmail) return;
      
      const emails = getEmails();
      const index = emails.findIndex(e => e.id === currentEmail.id);
      
      if (index !== -1) {
        emails.splice(index, 1);
        saveEmails(emails);
      }
      
      closeEmailViewer();
    }
    
    async function sendEmail() {
      const toEl = document.getElementById('emailTo');
      const subjectEl = document.getElementById('emailSubject');
      const messageEl = document.getElementById('emailMessage');
      const statusEl = document.getElementById('emailStatus');
      if (!toEl || !subjectEl || !messageEl || !statusEl) return;
      
      const to = toEl.value.trim();
      const subject = subjectEl.value.trim();
      const message = messageEl.value.trim();
      
      if (!to || !subject || !message) {
        statusEl.textContent = 'Please fill in all fields';
        statusEl.style.color = 'red';
        return;
      }
      
      // Basic email format validation
      if (!/^\S+@\S+\.\S+$/.test(to)) {
        statusEl.textContent = 'Invalid email address';
        statusEl.style.color = 'red';
        return;
      }
      
      const currentUser = localStorage.getItem('username') || 'guest';
      const emailId = Date.now();
      
      // Create email object (FROM uses id-username)
      const email = {
        id: emailId,
        from: getFullEmail(currentUser),
        to: to,
        subject: subject,
        message: message,
        date: new Date().toISOString(),
        read: true,
        folder: 'sent'
      };
      
      // Save to local storage
      const emails = getEmails();
      emails.push(email);
      saveEmails(emails);
      
      // Send via EmailJS
      try {
        statusEl.textContent = 'Sending email...';
        statusEl.style.color = 'blue';
        
        // If EmailJS fails, we still keep local sent copy; this is best-effort
        await emailjs.send(
          "service_8fxxr74", 
          "template_ebusf6s",
          {
            to_email: to,
            subject: subject,
            message: message,
            from_name: currentUser
          },
          "_bTXWlKkwC9VBx62d"
        );
        
        statusEl.textContent = 'Email sent successfully!';
        statusEl.style.color = 'green';
        
        // Send to Firebase for real-time delivery
        const recipientBase = to.split('@')[0]; // Extract local part
        // Convert id-username to username for firebase path
        const recipientUser = extractUsernameFromAddress(to);
        if (recipientUser) {
          database.ref('emails/' + recipientUser).push(email);
        } else if (recipientBase) {
          database.ref('emails/' + recipientBase).push(email);
        }
        
      } catch (error) {
        console.error('EmailJS error:', error);
        statusEl.textContent = 'Failed to send email (local copy saved).';
        statusEl.style.color = 'red';
      }
      
      // Clear form
      toEl.value = '';
      subjectEl.value = '';
      messageEl.value = '';
      
      // Show sent folder
      setTimeout(() => {
        showSent();
      }, 600);
    }
    
    function saveDraft() {
      const to = document.getElementById('emailTo')?.value.trim() || '';
      const subject = document.getElementById('emailSubject')?.value.trim() || '';
      const message = document.getElementById('emailMessage')?.value.trim() || '';
      const statusEl = document.getElementById('emailStatus');
      
      if (!statusEl) return;
      
      if (!to && !subject && !message) {
        statusEl.textContent = 'Draft is empty';
        statusEl.style.color = 'orange';
        return;
      }
      
      const drafts = JSON.parse(localStorage.getItem('emailDrafts') || '[]');
      drafts.push({
        to: to,
        subject: subject,
        message: message,
        date: new Date().toISOString()
      });
      
      localStorage.setItem('emailDrafts', JSON.stringify(drafts));
      
      statusEl.textContent = 'Draft saved';
      statusEl.style.color = 'blue';
    }
    
    // Show email notification
    function showEmailNotification(email) {
      // Update taskbar icon
      const emailIcon = Array.from(document.querySelectorAll('.icon')).find(el => el.textContent && el.textContent.includes('Email'));
      if (emailIcon) {
        emailIcon.innerHTML = 'üìß<br>Email <span style="color:red;font-size:12px;">‚óè</span>';
      }
      
      // Show desktop notification
      if (Notification.permission === 'granted') {
        new Notification('New Email', {
          body: `From: ${email.from}\nSubject: ${email.subject}`,
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>'
        });
      }
    }

    // Terminal commands
    function handleTerminalCommand(e) {
      if (e.key === 'Enter') {
        const input = document.getElementById('terminal-input');
        const output = document.getElementById('terminal-output');
        if (!input || !output) return;
        const command = input.value.trim();
        
        output.innerHTML += `\n> ${command}\n`;
        
        // Process command
        const response = processTerminalCommand(command);
        output.innerHTML += (response === undefined ? '' : response) + '\n';
        
        // Clear input and scroll to bottom
        input.value = '';
        output.scrollTop = output.scrollHeight;
      }
    }
    
    function processTerminalCommand(command) {
      const parts = command.split(' ').filter(Boolean);
      const cmd = parts[0] ? parts[0].toLowerCase() : '';
      const args = parts.slice(1);
      
      switch(cmd) {
        case 'help':
          return `Available commands:
help - Show this help
clear - Clear terminal
date - Show current date and time
echo [text] - Echo text
calc [expression] - Evaluate math expression
user - Show current user
theme [color] - Change background color
`;
        case 'clear':
          const out = document.getElementById('terminal-output');
          if (out) out.innerHTML = '';
          return '';
        case 'date':
          return new Date().toString();
        case 'echo':
          return args.join(' ');
        case 'calc':
          try {
            return String(Function(`"use strict"; return (${args.join(' ')})`)());
          } catch (e) {
            return `Error: ${e.message}`;
          }
        case 'user':
          return `Current user: ${localStorage.getItem('username') || 'guest'}`;
        case 'theme':
          if (args.length === 0) {
            return 'Usage: theme [color] - Available colors: red, green, blue, white, yellow, gray, purple';
          }
          const color = args[0].toLowerCase();
          if (backgroundColors[color]) {
            changeBackground(color);
            return `Background color changed to ${color}`;
          } else {
            return `Invalid color: ${color}. Available colors: red, green, blue, white, yellow, gray, purple`;
          }
        case '':
          return '';
        default:
          return `Command not found: ${cmd}. Type 'help' for available commands.`;
      }
    }

    // Browser functions
    function loadBrowserPage() {
      const urlInput = document.getElementById('urlInput');
      const browserFrame = document.getElementById('browserFrame');
      const browserStatus = document.getElementById('browserStatus');
      if (!urlInput || !browserFrame || !browserStatus) return;
      
      let url = urlInput.value.trim();
      
      // Add protocol if missing
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
      }
      
      try {
        browserFrame.src = url;
        browserStatus.textContent = `Loading: ${url}`;
      } catch (e) {
        browserStatus.textContent = `Error: ${e.message}`;
      }
    }
    
    function goBack() {
      const browserFrame = document.getElementById('browserFrame');
      try {
        browserFrame.contentWindow.history.back();
      } catch (e) {
        // Cross-origin restriction, can't go back
      }
    }
    
    function goForward() {
      const browserFrame = document.getElementById('browserFrame');
      try {
        browserFrame.contentWindow.history.forward();
      } catch (e) {
        // Cross-origin restriction, can't go forward
      }
    }
    
    function refreshPage() {
      const browserFrame = document.getElementById('browserFrame');
      if (browserFrame) browserFrame.src = browserFrame.src;
    }
    
    function openInNewTab() {
      const urlInput = document.getElementById('urlInput');
      if (!urlInput) return;
      let url = urlInput.value.trim();
      
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
      }
      
      window.open(url, '_blank');
    }

    // Other app functions
    function saveNote() {
      const noteArea = document.getElementById('noteArea');
      if (!noteArea) return;
      localStorage.setItem('note', noteArea.value);
      alert('Note saved!');
    }
    
    function saveFile() {
      const fileEditArea = document.getElementById('fileEditArea');
      const fileEditName = document.getElementById('fileEditName');
      if (!fileEditArea || !fileEditName) return;
      
      if (!fileEditName.value.trim()) {
        alert('Please enter a filename');
        return;
      }
      
      const files = JSON.parse(localStorage.getItem('files') || '{}');
      files[fileEditName.value] = fileEditArea.value;
      localStorage.setItem('files', JSON.stringify(files));
      alert('File saved!');
      // If file manager open, refresh it
      if (openApps.has('filemanager')) initializeFileManager();
    }
    
    function setVolume(value) {
      localStorage.setItem('volume', value);
    }
    
    function playTestSound() {
      const volume = parseFloat(localStorage.getItem('volume') || 0.5);
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 440;
      oscillator.type = 'sine';
      
      gainNode.gain.value = volume;
      
      oscillator.start();
      setTimeout(() => oscillator.stop(), 500);
    }
    
    function changeBackground(colorName) {
      const color = backgroundColors[colorName];
      if (color) {
        document.getElementById('desktop').style.background = color;
        localStorage.setItem('background-color', color);
      }
    }
    
    function playSelectedMusic(event) {
      const file = event?.target?.files?.[0];
      if (file) {
        const musicPlayer = document.getElementById('musicPlayer');
        if (!musicPlayer) return;
        musicPlayer.src = URL.createObjectURL(file);
        musicPlayer.play();
      }
    }
    
    function previewMedia(event) {
      const files = event?.target?.files;
      if (!files) return;
      const imagePreview = document.getElementById('imagePreview');
      const videoPreview = document.getElementById('videoPreview');
      
      if (imagePreview) imagePreview.innerHTML = '<h3>Images</h3>';
      if (videoPreview) videoPreview.innerHTML = '<h3>Videos</h3>';
      
      Array.from(files).forEach(file => {
        const url = URL.createObjectURL(file);
        
        if (file.type.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = url;
          if (imagePreview) imagePreview.appendChild(img);
        } else if (file.type.startsWith('video/')) {
          const video = document.createElement('video');
          video.src = url;
          video.controls = true;
          if (videoPreview) videoPreview.appendChild(video);
        }
      });
    }

    // Window management
    let activeWindow = null;
    let zIndex = 10;
    
    function openApp(id) {
      if (openApps.has(id)) {
        // App already open, bring to front
        const windowEl = document.getElementById(id);
        if (windowEl) {
          windowEl.style.zIndex = ++zIndex;
          activeWindow = windowEl;
          updateTaskbar();
          return;
        }
      }
      
      // Create app window
      const desktop = document.getElementById('desktop');
      const appHTML = apps[id];
      
      if (appHTML && desktop) {
        desktop.insertAdjacentHTML('beforeend', appHTML);
        const windowEl = document.getElementById(id);
        if (!windowEl) return;
        windowEl.style.display = 'flex';
        windowEl.style.zIndex = ++zIndex;
        activeWindow = windowEl;
        openApps.add(id);
        
        // Initialize app-specific functionality
        if (id === 'email') {
          // Update email address display immediately after creating the window
          updateEmailAddressDisplay();
          initializeEmail();
          initializeFirebaseListeners(localStorage.getItem('username'));
        }
        if (id === 'drawing') initializeDrawingApp();
        if (id === 'calendar') initializeCalendar();
        if (id === 'todo') initializeTodo();
        if (id === 'terminal') {
          const tIn = document.getElementById('terminal-input');
          if (tIn) tIn.focus();
        }
        if (id === 'filemanager') initializeFileManager();
        
        updateTaskbar();
      }
    }
    
    function closeApp(id) {
      const windowEl = document.getElementById(id);
      if (windowEl) {
        windowEl.remove();
        openApps.delete(id);
        updateTaskbar();
      }
    }
    
    function updateTaskbar() {
      taskbarApps.innerHTML = '';
      openApps.forEach(appId => {
        const appElement = document.createElement('div');
        appElement.className = 'taskbar-app';
        appElement.textContent = appNames[appId] || appId;
        appElement.addEventListener('click', () => {
          const windowEl = document.getElementById(appId);
          if (windowEl) {
            windowEl.style.zIndex = ++zIndex;
            activeWindow = windowEl;
          }
        });
        taskbarApps.appendChild(appElement);
      });
    }
    
    function dragWindow(e, windowEl) {
      if (!windowEl) return;
      e.preventDefault();
      
      // Bring window to front
      windowEl.style.zIndex = ++zIndex;
      activeWindow = windowEl;
      
      const startX = e.clientX;
      const startY = e.clientY;
      // compute starting left/top in pixels using computed style or bounding rect
      const comp = getComputedStyle(windowEl);
      const leftPx = parseFloat(comp.left);
      const topPx = parseFloat(comp.top);
      const startLeft = Number.isFinite(leftPx) ? leftPx : windowEl.getBoundingClientRect().left;
      const startTop = Number.isFinite(topPx) ? topPx : windowEl.getBoundingClientRect().top;
      
      function onMouseMove(ev) {
        const dx = ev.clientX - startX;
        const dy = ev.clientY - startY;
        
        windowEl.style.left = (startLeft + dx) + 'px';
        windowEl.style.top = (startTop + dy) + 'px';
        windowEl.style.transform = 'none'; // Remove centering transform
      }
      
      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }
      
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    }

    // Initialize file manager
    function initializeFileManager() {
      const fileListContainer = document.getElementById('fileList');
      if (!fileListContainer) return;
      const files = JSON.parse(localStorage.getItem('files') || '{}');
      
      fileListContainer.innerHTML = '<h3>Files</h3>';
      const ul = document.createElement('ul');
      ul.style.listStyle = 'none';
      ul.style.padding = '0';
      
      for (const [name, content] of Object.entries(files)) {
        const listItem = document.createElement('li');
        listItem.style.display = 'flex';
        listItem.style.justifyContent = 'space-between';
        listItem.style.padding = '5px';
        listItem.style.borderBottom = '1px solid #ddd';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = name;
        
        const actionsDiv = document.createElement('div');
        const openBtn = document.createElement('button');
        openBtn.textContent = 'Open';
        openBtn.onclick = function() { openFile(name); };
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.onclick = function() { deleteFile(name); };
        actionsDiv.appendChild(openBtn);
        actionsDiv.appendChild(delBtn);
        
        listItem.appendChild(nameSpan);
        listItem.appendChild(actionsDiv);
        ul.appendChild(listItem);
      }
      
      fileListContainer.appendChild(ul);
      
      if (Object.keys(files).length === 0) {
        const p = document.createElement('p');
        p.textContent = 'No files saved yet.';
        fileListContainer.appendChild(p);
      }
    }
    
    function openFile(name) {
      const files = JSON.parse(localStorage.getItem('files') || '{}');
      openApp('fileeditor');
      
      // Wait for editor to open then populate
      setTimeout(() => {
        const area = document.getElementById('fileEditArea');
        const nameInput = document.getElementById('fileEditName');
        if (area && nameInput) {
          area.value = files[name] || '';
          nameInput.value = name;
        }
      }, 150);
    }
    
    function deleteFile(name) {
      const files = JSON.parse(localStorage.getItem('files') || '{}');
      delete files[name];
      localStorage.setItem('files', JSON.stringify(files));
      initializeFileManager();
    }

    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
  </script>
</body>
</html>